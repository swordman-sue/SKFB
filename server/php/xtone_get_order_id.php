<?php/** * sign  接口 *///http://lyxm.gamei.cn/pay/www/api/shenmozg/pay.php?act=getorder&userID=64&productID=com.cocoentertainment.leihuoyidao.iap.tier1&productName=1000元宝&productDesc=支付10元获取1000元宝&money=1000&roleID=3&roleName=柯冰珍&serverID=1&serverName=1&extension=shenmozg_413b02f8-68c5-482c-b7b8-fea2d06d10ac	header("Content-type: text/html; charset=utf-8");	//include '../_include/pay_no_charge.php';	//$notifyUrl = 'http://www.skfb-xtone-dz-game-server.gzzlgame.com:16888/xtone/dz/recharge_callback';		$data = $_REQUEST;		//$appkey = "578ecd1545aaa270578a81d92f43873e";	//$appsecret = "346847fb53ddb3eafafa51ae240bac8a";		$appkey = trim($data['appkey']);	$appsecret = trim($data['appsecret']);	$notifyUrl = trim($data['notifyUrl']);		file_put_contents('./log.html',date("Y-m-d H:i:s").'REQUEST:'.print_r($_REQUEST,1)."<br>",FILE_APPEND); 	$str = file_get_contents("php://input"); 	file_put_contents('./log.html',date("Y-m-d H:i:s").'php://input：'.print_r($str,1)."<br>",FILE_APPEND);	if(isset($_REQUEST['act']) && (trim($_REQUEST['act']) == 'getorder')){		//	获取订单号//		$url = "http://121.40.243.171:8080/u8server/getOrderID";//	旧的 20160605		//$url = "http://121.40.243.171:8080/u8server/pay/getOrderID";//	新的 20160607				//$url = "http://oss.vanggame.com:8080/pay/obtainOrder";    //		$url = trim($data['reqOrderIdUrl']); // "http://vserver.cyjj8.com:8080/pay/obtainOrder";					//var params = util.format('&userID=%s&productID=%s&productName=%s&productDesc=%s&money=%d&roleID=%s&roleName=%s&serverID=%s&serverName=%s&extension=%s',	//userID, productID, productName, productDesc, money, roleID, roleName, serverID, serverName, extension);							$postData = array(			'userID'		=> trim($data['userID']),			'productID'		=> trim($data['productID']),			'productName'	=> trim($data['productName']),			'productDesc'	=> trim($data['productDesc']),			'money'			=> trim($data['money']),			'roleID'		=> trim($data['roleID']),			'roleName'		=> trim($data['roleName']),			'serverID'		=> trim($data['serverID']),			'serverName'	=> trim($data['serverName']),			'extension'		=> trim($data['extension']),			'notifyUrl'		=>	$notifyUrl		);		$signStr = '';		foreach($postData as $k => $v){			$signStr .= $k.'='.$v.'&';		}		$signStr = trim($signStr,'&');		$signStr .= $appkey;				//print_r($signStr);				//$signStr = urlencode($signStr);		$postData['signType'] = 'md5';		$postData['sign'] = md5($signStr);		file_put_contents('./log.html',date("Y-m-d H:i:s").'POST_DATA:'.print_r($postData,1)."<br>",FILE_APPEND);		$return = curl_post($url,$postData);		file_put_contents('./log.html',date("Y-m-d H:i:s").'POST_RETURN:'.print_r($return,1)."<br>",FILE_APPEND);		//{"data":{"extension":"","orderID":977471390485577731},"state":1}		$return = preg_replace("/ID\":(\d*)}/",'ID":"$1"}',$return);		$returnObj = json_decode($return,true);		if($returnObj['state'] == '1'){			echo $return;			//print_r($returnObj);			//print_r(json_encode(array('orderId'=>(string)$returnObj['data']['orderID'],'extension'=>$returnObj['data']['extension'])));			//exit;		}else{			print_r($returnObj);			print_r('fail');			exit;		}	}else{		//test//		$data = '{"data":{"extension":"shenmozg_335c712d-ea67-49ae-9a47-d90f5a6abf21","sign":"a13ab369a1bf2f99f82e5c8d79d5f6b0","userID":64,"orderID":977492388580687873,"gameID":5,"channelID":1704,"signType":"md5","money":10000,"serverID":"1","productID":"com.cocoentertainment.leihuoyidao.iap.tier100","currency":"RMB"},"state":1}';		$data = file_get_contents("php://input");		$data = preg_replace("/ID\":(\d*),/",'ID":"$1",',$data);		$data = json_decode($data,true);		$state = $data['state'];		$data = $data['data'];		$sign = $data['sign'];		unset($data['sign']);		$signStr = 'channelID='.$data['channelID'].'&currency='.$data['currency'].'&extension='.$data['extension'].'&gameID='.$data['gameID'].'&money='.$data['money'].'&orderID='.$data['orderID'].'&productID='.$data['productID'].'&serverID='.$data['serverID'].'&userID='.$data['userID'].'&'.$appsecret;		$mySign = md5($signStr);		if(($state == '1') && ($mySign == $sign)){			//	签名成功	业务处理			$money =  intval($data['money']);			//分转换为元			//对象			$ApiPayment = new ApiPayment();			//属性			$ApiPayment->pay_no				= $data['extension'];		//订单号			$ApiPayment->pay_no_platform	= $data['orderID'];		//订单号			$ApiPayment->server_id 		= intval($data['serverID']);			$ApiPayment->money				= $money;			$ApiPayment->time				= time();		//充值时间戳			$ApiPayment->platformid		= 'shenmozg' ;//平台ID			$returnInfo =  $ApiPayment -> doPayment($pay_key);			print_r("SUCCESS");			exit;		}else{			print_r("FAIL");			exit;		}	}	/**	 * 发起HTTPS请求 的curl请求	 */	function curl_post($url,$data,$cookiePath = '')	{		$ch = curl_init ();		curl_setopt ( $ch, CURLOPT_URL, $url );		curl_setopt ( $ch, CURLOPT_POST, 1 );		curl_setopt ( $ch, CURLOPT_HEADER, 0 );		if($cookiePath){			// 保存cookie信息			curl_setopt ( $ch, CURLOPT_COOKIEJAR, $cookiePath );			// 读取cookie信息			curl_setopt ( $ch, CURLOPT_COOKIEFILE, $cookiePath);		}		//	curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,"http://www.qingyidai.com");		// 设置为1是，捕获不输出		curl_setopt ( $ch, CURLOPT_RETURNTRANSFER, 1 );		curl_setopt ( $ch, CURLOPT_POSTFIELDS, $data );		$return = curl_exec ( $ch );		curl_close ( $ch );		return $return;	}	function decodeUnicode($str)	{		return preg_replace_callback('/\\\\u([0-9a-f]{4})/i',				create_function(						'$matches',						'return mb_convert_encoding(pack("H*", $matches[1]), "UTF-8", "UCS-2BE");'				),				$str);	}?>